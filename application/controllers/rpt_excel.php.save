<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Rpt_excel extends CI_Controller {


	public function __construct()
	{
		parent::__construct();
		$this->load->helper('url');
    	$this->load->helper('form');
    	$this->load->model('reportes_model');
    	$this->load->library('session');
    	$this->load->library('excel');

	}

	public function porvendedor(){
		$this->excel->setActiveSheetIndex(0);
        $this->excel->getActiveSheet()->setTitle('Reporte de vendedor');
        //$this->excel->getActiveSheet()->setCellValue('A1', 'Un poco de texto');
        //$this->excel->getActiveSheet()->getStyle('A1')->getFont()->setBold(true);
        $this->excel->getActiveSheet()->getDefaultRowDimension()->setRowHeight(15); 


        $vendedor = $this->reportes_model->vendedores_rpt_i($_POST['cod_vendedor'],$_POST['sem']);

	    $coordinador = $this->reportes_model->coordinador_($vendedor['id_coordinador']);

	    $ventas = $this->reportes_model->ventas($vendedor['id_vendedor'],$vendedor['id_semana']);

        $style = array(
	        'alignment' => array('horizontal' => PHPExcel_Style_Alignment::HORIZONTAL_CENTER, ),
	        'borders' => array(
            	'allborders' => array(
	                'style' => PHPExcel_Style_Border::BORDER_THIN,
	                'color' => array('rgb' => '000000')
	            )
	        ),
	        'font'  => array(
	            'bold'  => true,
	            'color' => array('rgb' => '000000'),
	            'size'  => 7
        	),
	    );
	    $style2 = array(
	        'alignment' => array('horizontal' => PHPExcel_Style_Alignment::HORIZONTAL_CENTER, ),
	        'font'  => array(
	            'bold'  => true,
	            'color' => array('rgb' => '000000'),
	            'size'  => 7
        	),
	    );

        $style3 = array(
            'alignment' => array('horizontal' => PHPExcel_Style_Alignment::HORIZONTAL_CENTER, ),
            'font'  => array(
                'bold'  => false,
                'color' => array('rgb' => '000000'),
                'size'  => 7
            ),
        );

        $this->excel->getDefaultStyle()->applyFromArray($style3);
        $this->excel->getActiveSheet()->setCellValue('A2', 'Estado de Cuenta de Comisiones');
        $this->excel->getActiveSheet()->mergeCells('A2:G2');

        $this->excel->getActiveSheet()->setCellValue('A3', 'SEM '.$vendedor['nsem'].' '.$vendedor['desde'].' AL '.$vendedor['hasta']);
        $this->excel->getActiveSheet()->mergeCells('A3:G3');

        $this->excel->getActiveSheet()->setCellValue('A4', 'Vendedor: ['.$vendedor['cod_vendedor'].'] '.$vendedor['apellidos'].' '.$vendedor['nombres']);
        $this->excel->getActiveSheet()->mergeCells('A4:G4');

        $this->excel->getActiveSheet()->setCellValue('A5', 'Coordinador: '.$coordinador['apellidos'].' '.$coordinador['nombres']);
        $this->excel->getActiveSheet()->mergeCells('A5:G5');

        $this->excel->getActiveSheet()->setCellValue('A7', 'ASIGNACIONES');
        $this->excel->getActiveSheet()->mergeCells('A7:B7');
        $this->excel->getActiveSheet()->getStyle('A2:G5')->applyFromArray($style2);
        $this->excel->getActiveSheet()->getStyle('A7:B7')->applyFromArray($style2);


        $this->excel->getActiveSheet()->setCellValue('A9', 'Semana');
        $this->excel->getActiveSheet()->setCellValue('B9', 'Asegurado');
        $this->excel->getActiveSheet()->setCellValue('C9', 'Cedula');
        $this->excel->getActiveSheet()->setCellValue('D9', 'Tipo de Venta');
        $this->excel->getActiveSheet()->setCellValue('E9', 'Plan');
        $this->excel->getActiveSheet()->setCellValue('F9', 'S.A');
        $this->excel->getActiveSheet()->setCellValue('G9', 'Cuotas');
        $this->excel->getActiveSheet()->setCellValue('H9', 'Comisión');
        $this->excel->getActiveSheet()->getStyle("A9:H9")->applyFromArray($style);
        $comision_l=0;

        $i=10;
        if(count($ventas)>0){
        foreach ($ventas as $key) {
            if(isset($key['tpoliza'])) $tpoliza = $key['tpoliza']; else  $tpoliza = 'NO APLICA';

            $this->excel->getActiveSheet()->setCellValue('A'.$i, $key['nsem']);
        	$this->excel->getActiveSheet()->setCellValue('B'.$i, strtoupper($key['apellidos'].' '.$key['nombres']));
	        $this->excel->getActiveSheet()->setCellValue('C'.$i, $key['identificacion']);
	        $this->excel->getActiveSheet()->setCellValue('D'.$i, strtoupper($key['concepto']));
	        $this->excel->getActiveSheet()->setCellValue('E'.$i, $tpoliza);
	        $this->excel->getActiveSheet()->setCellValue('F'.$i, number_format($key['suma'], 2, ',', '.'));
	        $this->excel->getActiveSheet()->setCellValue('G'.$i, number_format($key['cuotas_canceladas'], 2, ',', '.'));
	        $this->excel->getActiveSheet()->setCellValue('H'.$i, number_format($key['comision_liquidada'], 2, ',', '.'));
            
            if ($key['id_semana']!=$key['id_sem']) {
                $this->excel->getActiveSheet()->setCellValue('I'.$i, 'DOMICILIADA');
            }

	        $i++;
			$comision_l=$comision_l+$key['comision_liquidada'];

	    }

        }else{
        	$this->excel->getActiveSheet()->setCellValue('A'.$i, 'No hay nada que reportar');
        	$this->excel->getActiveSheet()->mergeCells('A'.$i.':H'.$i);
       		$this->excel->getActiveSheet()->getStyle('A'.$i.':H'.$i)->applyFromArray($style);
        }
        $i++;

        $this->excel->getActiveSheet()->setCellValue('A'.$i, 'DEDUCCIONES');
        $this->excel->getActiveSheet()->mergeCells('A'.$i.':B'.$i);
        $this->excel->getActiveSheet()->getStyle('A'.$i.':B'.$i)->applyFromArray($style2);


        $i=$i+2;

        $this->excel->getActiveSheet()->setCellValue('B'.$i, 'Asegurado');
        $this->excel->getActiveSheet()->setCellValue('C'.$i, 'Cedula');
        $this->excel->getActiveSheet()->setCellValue('D'.$i, 'Tipo de Venta');
        $this->excel->getActiveSheet()->setCellValue('E'.$i, 'Poliza');
        $this->excel->getActiveSheet()->setCellValue('F'.$i, 'S.A');
        $this->excel->getActiveSheet()->setCellValue('G'.$i, 'Cuotas');
        $this->excel->getActiveSheet()->setCellValue('H'.$i, 'Comisión');
        $this->excel->getActiveSheet()->getStyle('B'.$i.':H'.$i)->applyFromArray($style);

        $extornos_l=0;

    	$extornos = $this->reportes_model->extornos_rpt_i($vendedor['id_vendedor'],$vendedor['id_semana']);

    	$i++;
    	if(count($extornos)>0){

    	foreach ($extornos as $key) {

            if(isset($key['tpoliza'])) $tpoliza = $key['tpoliza']; else  $tpoliza = 'NO APLICA';

        	$this->excel->getActiveSheet()->setCellValue('B'.$i, strtoupper($key['apellidos'].' '.$key['nombres']));
	        $this->excel->getActiveSheet()->setCellValue('C'.$i, $key['identificacion']);
	        $this->excel->getActiveSheet()->setCellValue('D'.$i, strtoupper($key['concepto']));
	        $this->excel->getActiveSheet()->setCellValue('E'.$i, $tpoliza);
	        $this->excel->getActiveSheet()->setCellValue('F'.$i, number_format($key['suma'], 2, ',', '.'));
	        $this->excel->getActiveSheet()->setCellValue('G'.$i, number_format($key['cuotas_canceladas'], 2, ',', '.'));
	        $this->excel->getActiveSheet()->setCellValue('H'.$i, number_format($key['monto_fraccionar'], 2, ',', '.'));
	        $i++;

	        $extornos_l = $extornos_l + $key['monto_fraccionar'];

        }
    	}else{
        	$this->excel->getActiveSheet()->setCellValue('B'.$i, 'No hay nada que reportar');
        	$this->excel->getActiveSheet()->mergeCells('B'.$i.':H'.$i);
       		$this->excel->getActiveSheet()->getStyle('B'.$i.':H'.$i)->applyFromArray($style);
    	$i++;

        }

    	$i++;
    	$total=$comision_l-$extornos_l;

        $this->excel->getActiveSheet()->setCellValue('G'.$i, 'TOTAL');
        $this->excel->getActiveSheet()->setCellValue('H'.$i, number_format($total, 2, ',', '.'));
        $this->excel->getActiveSheet()->getStyle('G'.$i.':H'.$i)->applyFromArray($style);

        $i=$i+2;


        $ventasd = $this->reportes_model->ventasd($vendedor['id_vendedor'],$vendedor['id_semana']);
        $this->excel->getActiveSheet()->setCellValue('A'.$i, 'VENTAS CON DOMICILIACION DE PAGO');
        $this->excel->getActiveSheet()->mergeCells('A'.$i.':D'.$i);
        $this->excel->getActiveSheet()->getStyle('A'.$i.':D'.$i)->applyFromArray($style2);


        $i=$i+2;

        $this->excel->getActiveSheet()->setCellValue('B'.$i, 'Asegurado');
        $this->excel->getActiveSheet()->mergeCells('B'.$i.':C'.$i);
        $this->excel->getActiveSheet()->setCellValue('D'.$i, 'Cedula');
        $this->excel->getActiveSheet()->setCellValue('E'.$i, 'Tipo de Venta');
        $this->excel->getActiveSheet()->setCellValue('F'.$i, 'Plan');
        $this->excel->getActiveSheet()->setCellValue('G'.$i, 'S.A');
        $this->excel->getActiveSheet()->setCellValue('H'.$i, 'Cuotas');
        $this->excel->getActiveSheet()->getStyle('B'.$i.':H'.$i)->applyFromArray($style);

        $i++;

    if(count($ventasd)>0){
        foreach ($ventasd as $key) {
            if(isset($key['tpoliza'])) $tpoliza = $key['tpoliza']; else  $tpoliza = 'NO APLICA';

            $this->excel->getActiveSheet()->setCellValue('B'.$i, strtoupper($key['apellidos'].' '.$key['nombres']));
            $this->excel->getActiveSheet()->mergeCells('B'.$i.':C'.$i);
            $this->excel->getActiveSheet()->setCellValue('D'.$i, $key['identificacion']);
            $this->excel->getActiveSheet()->setCellValue('E'.$i, strtoupper($key['concepto']));
            $this->excel->getActiveSheet()->setCellValue('F'.$i, $tpoliza);
            $this->excel->getActiveSheet()->setCellValue('G'.$i, number_format($key['suma'], 2, ',', '.'));
            $this->excel->getActiveSheet()->setCellValue('H'.$i, number_format($key['cuotas_canceladas'], 2, ',', '.'));

            
            $i++;


        }

    }else{
            $this->excel->getActiveSheet()->setCellValue('B'.$i, 'No hay nada que reportar');
            $this->excel->getActiveSheet()->mergeCells('B'.$i.':H'.$i);
            $this->excel->getActiveSheet()->getStyle('B'.$i.':H'.$i)->applyFromArray($style);
    }

        header('Content-Type: application/vnd.ms-excel');
        header('Content-Disposition: attachment;filename="'.$vendedor['cod_vendedor'].'_'.$vendedor['nsem'].'_'.$vendedor['apellidos'].'_'.$vendedor['nombres'].'.xls"');
        header('Cache-Control: max-age=0'); //no cache
        $objWriter = PHPExcel_IOFactory::createWriter($this->excel, 'Excel5');
        // Forzamos a la descarga
        $objWriter->save('php://output');
	}


	public function porcoordinador(){
		$this->excel->setActiveSheetIndex(0);
        $this->excel->getActiveSheet()->setTitle('Reporte de Coordinador');
        $this->excel->getActiveSheet()->getDefaultRowDimension()->setRowHeight(15); 


        $sem = $this->reportes_model->semana($_POST['sem']);
    	$coordinador = $this->reportes_model->coordinador($_POST['cod_vendedor']);

    	$vendedores = $this->reportes_model->vendedores_rpt_general($coordinador['id_user'],$sem['id_semana']);

    	/*print_r($vendedores);
    	echo count($vendedores);
    	break;*/

        $style = array(
	        'alignment' => array('horizontal' => PHPExcel_Style_Alignment::HORIZONTAL_CENTER, ),
	        'borders' => array(
            	'allborders' => array(
	                'style' => PHPExcel_Style_Border::BORDER_THIN,
	                'color' => array('rgb' => '000000')
	            )
	        ),
	        'font'  => array(
	            'bold'  => true,
	            'color' => array('rgb' => '000000'),
	            'size'  => 7
        	),
	    );
	    $style2 = array(
	        'alignment' => array('horizontal' => PHPExcel_Style_Alignment::HORIZONTAL_CENTER,
	        					 'vertical' => PHPExcel_Style_Alignment::VERTICAL_CENTER, ),
	        'font'  => array(
	            'bold'  => true,
	            'color' => array('rgb' => '000000'),
	            'size'  => 7
        	),
	    );

        $this->excel->getDefaultStyle()->applyFromArray($style2);
        $this->excel->getActiveSheet()->setCellValue('A2', 'Estado de Cuenta de Comisiones General');
        $this->excel->getActiveSheet()->mergeCells('A2:G2');

        $this->excel->getActiveSheet()->setCellValue('A3', 'SEM '.$sem['nsem'].' '.$sem['desde'].' AL '.$sem['hasta']);
        $this->excel->getActiveSheet()->mergeCells('A3:G3');

        $this->excel->getActiveSheet()->setCellValue('A4', 'Coordinador: '.$coordinador['apellidos'].' '.$coordinador['nombres']);
        $this->excel->getActiveSheet()->mergeCells('A4:G4');

        $this->excel->getActiveSheet()->setCellValue('A7', 'ASIGNACIONES');
        $this->excel->getActiveSheet()->mergeCells('A7:B7');

        $this->excel->getActiveSheet()->setCellValue('A9', 'Vendedor');
        $this->excel->getActiveSheet()->mergeCells('A9:B9');
        $this->excel->getActiveSheet()->setCellValue('C9', 'Codigo');
        $this->excel->getActiveSheet()->setCellValue('D9', 'Tipo de Venta');
        $this->excel->getActiveSheet()->setCellValue('E9', 'Operaciones');
        $this->excel->getActiveSheet()->setCellValue('F9', 'Comisión');
        $this->excel->getActiveSheet()->setCellValue('G9', 'Coordinador');
        $this->excel->getActiveSheet()->getStyle("A9:G9")->applyFromArray($style);
        $comision_l=0;

        $i=10;
        $x=0;
        $n=0;
        if(count($vendedores)>0){
        foreach ($vendedores as $value) {

            if(($x==0) or ($n!=$value['id_vendedor'])){

    			$cel = $this->reportes_model->hcell($value['id_vendedor'],$sem['id_semana']);
    			$comision = $this->reportes_model->comisiones($value['id_vendedor'],$sem['id_semana']);

    			//print_r($comision);
    			if (count($cel)>1) $cell=count($cel)+$i;
    			else $cell=$i;

    			$this->excel->getActiveSheet()->setCellValue('A'.$i, $value['apellidos'].' '.$value['nombres']);
	        	$this->excel->getActiveSheet()->mergeCells('A'.$i.':B'.$cell);
	        	$this->excel->getActiveSheet()->setCellValue('C'.$i, $value['cod_vendedor']);
	        	$this->excel->getActiveSheet()->mergeCells('C'.$i.':C'.$cell);

                $x=0;
				
			} 

            $n=$value['id_vendedor'];
			$total=$total+$cel[$x]['total'];
			$cvendedor=$cvendedor+$comision[$x]['comision'];
			$ccoordinador=$ccoordinador+($comision[$x]['comision_c']);

        	
	        $this->excel->getActiveSheet()->setCellValue('D'.$i, $value['concepto']);
	        $this->excel->getActiveSheet()->setCellValue('E'.$i, $cel[$x]['total']);
	        $this->excel->getActiveSheet()->setCellValue('F'.$i, number_format($comision[$x]['comision'], 2, ',', '.'));
	        $this->excel->getActiveSheet()->setCellValue('G'.$i, number_format($comision[$x]['comision_c'], 2, ',', '.'));
	        $i++;
	        $x++;

	    }

        }else{
        	$this->excel->getActiveSheet()->setCellValue('A'.$i, 'No hay nada que reportar');
        	$this->excel->getActiveSheet()->mergeCells('A'.$i.':G'.$i);
       		$this->excel->getActiveSheet()->getStyle('A'.$i.':G'.$i)->applyFromArray($style);
        }
        $i++;

        $this->excel->getActiveSheet()->setCellValue('D'.$i, 'Total Asignaciones');
        $this->excel->getActiveSheet()->setCellValue('E'.$i, number_format($total, 2, ',', '.'));
        $this->excel->getActiveSheet()->setCellValue('F'.$i, number_format($cvendedor, 2, ',', '.'));
        $this->excel->getActiveSheet()->setCellValue('G'.$i, number_format($ccoordinador, 2, ',', '.'));
        $this->excel->getActiveSheet()->getStyle('E'.$i.':G'.$i)->applyFromArray($style);



        $i=$i+2;

        $this->excel->getActiveSheet()->setCellValue('A'.$i, 'DEDUCCIONES');
        $this->excel->getActiveSheet()->mergeCells('A'.$i.':B'.$i);

        $i=$i+2;

        $this->excel->getActiveSheet()->setCellValue('A'.$i, 'Tomador');
        $this->excel->getActiveSheet()->setCellValue('B'.$i, 'Cedula');
        $this->excel->getActiveSheet()->setCellValue('C'.$i, 'Causa');
        $this->excel->getActiveSheet()->setCellValue('D'.$i, 'S.A');
        $this->excel->getActiveSheet()->setCellValue('E'.$i, 'Cuotas');
        $this->excel->getActiveSheet()->setCellValue('F'.$i, 'Comisión');
        $this->excel->getActiveSheet()->setCellValue('G'.$i, 'Coordinador');
        $this->excel->getActiveSheet()->getStyle('A'.$i.':G'.$i)->applyFromArray($style);


    	$extornos = $this->reportes_model->extornos_rpt_g($coordinador['id_user'],$sem['id_semana']);


    	$i++;
    	if(count($extornos)>0){

    	foreach ($extornos as $value) {
        	$this->excel->getActiveSheet()->setCellValue('A'.$i, $value['apellidos'].' '.$value['nombres']);
	        $this->excel->getActiveSheet()->setCellValue('B'.$i, $value['identificacion']);
	        $this->excel->getActiveSheet()->setCellValue('C'.$i, $value['motivo']);
	        $this->excel->getActiveSheet()->setCellValue('D'.$i, number_format($value['suma'], 2, ',', '.'));
	        $this->excel->getActiveSheet()->setCellValue('E'.$i, '');
	        $this->excel->getActiveSheet()->setCellValue('F'.$i, number_format($value['monto_fraccionado'], 2, ',', '.'));
	        $this->excel->getActiveSheet()->setCellValue('G'.$i, number_format($value['monto_fraccionado_c'], 2, ',', '.'));
	        $i++;

	        $evendedor = $evendedor + $value['monto_fraccionado'];
			$ecoordinador = $ecoordinador + $value['monto_fraccionado_c'];

        }
    	}else{
        	$this->excel->getActiveSheet()->setCellValue('A'.$i, 'No hay nada que reportar');
